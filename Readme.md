# 32位多核j1cpu

2021.7

##简介

此cpu为4个核心的j1cpu，4个核心分别为1个主核，3个从核。主核可以独立运行j1forth系统，在系统中运行新定义词（非系统自带词）时，系统会自动分配到从核中运行。
uart串口输出改变使用词showcore，以查看从核的输出。

forth系统 使用gforth进行编译，编译方法执行以下命令：gforth j1.4th

cpu目前工作频率：100Mhz

## cpu更新

### 2021.7
修改为32位cpu

### 2021.8.3
添加2核心，使cpu成为3核心cpu

内存分配如下（16384*32b=64KB）：

ram:0-3fff	(单位：字)

此阶段3个核心只能运行j1forth，不能运行新定义的词。

### 2021.8.27

修改内存分配，使cpu可以完全正常运行

内存分配如下（12288*32b + 4096*32b=48KB + 16KB = 64KB）：

rom0、rom1：0 - fff		(单位：字)

ram：1000 - 2fff		(单位：字)

### 2021.9.16

增加内核任务分配机制，使得任务可以通过主核分配给不同内核

## j1forth更新

j1forth为32位forth系统

### 2021.7

修改为32位forth系统

### 2021.8.3

系统空闲内存地址为：e00-7cff	(单位：字节)

系统变量存储地址为：7d00-7dff	(单位：字节)

系统输入缓冲地址为：7e00-7fff	(单位：字节)

forth系统划定内存为8192*32b=32KB

### 2021.8.27

系统空闲内存地址为：4100-bdff	(单位：字节)

系统变量存储地址为：4000-40ff	(单位：字节)

系统输入缓冲地址为：be00-bfff	(单位：字节)

forth系统划定内存调整为49152*32b=48KB

### 2021.9.16

修改系统，增加多任务分配机制以及Uart输出重定向机制

### 2021.10.1

修复漏洞，优化rtl代码，处理器工作频率增加至100Mhz

### 2021.10.14

修复漏洞，优化代码

### 2021.10.17

增加串口波特率至3000000；增加串口rs232缓冲区，缓冲区大小为256B

### 2021.11.13

精简结构，删除串口缓冲区
增加cpu核心，目前为4核

### 2021.12

增加cache缓存技术；增加串口接收缓冲区，缓冲区大小为256B

首先，把指令（数据）按页进行划分，因为总线宽为128位，所以每页都有4条32位指令。考虑到forth里面有非常多的跳转指令，因此一级的cache尽量每页都尽可能的小，页数尽可能多。页小可以减少频繁跳转带来的页面换入换出造成的资源浪费。在跳转指令中call指令占据了大多数，所以在大多数跳转后还要返回到call指令处继续执行，页数多有利于程序的返回。forth程序满足局部性原理。
	一级cache采用的映射方案为4路组相连，大小为8组，每组4路，每路1页，每页4个指令，共8*4*1*4*32bit=4096bit=512B；置换算法为LRU（最近最久未用）。每个核心都有一个指令cache（512B）和一个数据cache（512B），数据cache中修改过的数据一级cache采用直写法，将数据写入二级cache，由于采用直接法，一级cache不需要页面换出。数据一致性采用广播方式来保证数据的正确性。
    二级cache采用的映射方案为直接映射法，大小为512页，每页4个指令，共512*4*32bit=65536bit=8192B；二级cache为共享cache。cache中修改过的数据一级cache采用写回法，需要将修改过的数据写回RAM中。

————————————————————————————————————————————————————————————————————————————————————
           |  映射方法   | 置换算法 | 数据写出方法 | 数据一致性 |  大小  | 使用方式 
-----------|------------|----------|--------------|------------|--------|----------
 一级cache | 4路组相连法 |   LRU     |    直写法    |    广播     |  512B  |   独享   
-----------|------------|-----------|--------------|------------|--------|----------
 二级cache | 直接映射法  |    无     |    写回法    |     无      |  8192B |   共享   
————————————————————————————————————————————————————————————————————————————————————